{% extends "base.html" %}
{% block content %}

<div class="search-container">
  <form method="get" action="{{ url_for('views.dictionary') }}">
    <input type="text" name="search" placeholder="Search Chinese words..." value="{{ request.args.get('search', '') }}">
    <button type="submit">Search</button>
  </form>
</div>

<table class="dictionary-table">
  <thead>
    <tr>
      <th>Chinese</th>
      <th>Pinyin</th>
      <th>English</th>
      <th>Audio</th>
      <th>Image</th>
      <th>Save</th> 
    </tr>
  </thead>
  <tbody>
    {% for word in words %}
    <tr>
      <td style="color: {% if word.part_of_speech == 'noun' %}green{% elif word.part_of_speech == 'verb' %}blue{% elif word.part_of_speech == 'adjective' %}yellow{% elif word.part_of_speech == 'adverb' %}orange{% elif word.part_of_speech == 'pronoun' %}purple{% elif word.part_of_speech == 'preposition' %}pink{% elif word.part_of_speech == 'conjunction' %}grey{% elif word.part_of_speech == 'interjection' %}red{% elif word.part_of_speech == 'measure word' %}brown{% elif word.part_of_speech == 'particle' %}lightblue{% endif %}">
        {{ word.chinese }}
      </td>
      <td>{{ word.pinyin }}</td>
      <td>{{ word.english }}</td>
      <td>
        {% if word.audio %}
        <button class="play-button" onclick="playAudio(this)" data-audio-url="{{ word.audio }}">
          ðŸ”Š Play
        </button>
        {% else %}
        No audio
        {% endif %}
      </td>
      <td>
        {% if word.image %}
        <img src="{{ word.image }}" alt="{{ word.english }}" width="80">
        {% else %}
        No image
        {% endif %}
      </td>
      <td>
        <button
        class="known-button"
        onclick="markKnown(this)"
        data-word-id="{{ word.id }}"
        style="{% if word.id in known_word_ids %}background-color: #4CAF50; color: white;{% endif %}"
        {% if word.id in known_word_ids %}disabled{% endif %}
      >
        {% if word.id in known_word_ids %}âœ“ Saved{% else %}âœ“ Known{% endif %}
      </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
function playAudio(button) {
  const audioUrl = button.getAttribute('data-audio-url');
  const audio = new Audio(audioUrl);
  audio.play().catch(e => console.error("Audio playback failed:", e));
}

function markKnown(button) {
  const wordId = button.getAttribute('data-word-id');

  fetch('/mark_known', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ word_id: wordId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      button.style.backgroundColor = '#4CAF50';  // green
      button.style.color = 'white';
      button.disabled = true;
      button.innerText = 'âœ“ Saved';
    } else {
      alert(data.message);
    }
  })
  .catch(err => {
    console.error('Error:', err);
    alert('Something went wrong. Please try again.');
  });
}
</script>

{% endblock %}